<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>Cascadia Earthquake Catalog Viewer</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <link rel="stylesheet" href="/src/style.css">
    <link rel="icon" type="image/png" href="/src/resources/favicon.ico" />
</head>

<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">Loading earthquakes...</div>
        </div>
    </div>
    
    <header class="app-header">
        <div class="header-left">
            <img src="/src/resources/Crescent_Logo.png" alt="CRESCENT" class="crescent-logo">
            <img src="/src/resources/USNSF_Logo.png" alt="NSF" class="nsf-logo">
        </div>
        
        <div class="header-center" style="font-size: 30px; font-weight: 600;">
            Cascadia Earthquake Catalog Viewer
        </div>
        
        <div class="header-right">
            <a href="/viewer3d.html" class="btn-glass" onclick="cleanup2D()">3D View â†’</a>
            <button class="btn-glass" onclick="openAboutModal()">About</button>
        </div>
    </header>


    <div id="map-wrapper">
        <div id="map"></div>
        <div id="zoom-level-display" class="zoom-level-box">Zoom: --</div>
    </div>

    <div class="sidebar-container">
        <div class="glass-panel" id="filters-panel">
            <div class="panel-header">Catalog & Filters</div>
            
            <div class="filter-group-clean">
                <label class="label-clean catalog-label">Catalog</label>
                <select id="catalog-select" class="select-clean">
                    <option value="2">Bostock et al. (2015) â€” Southern Vancouver Island LFEs (259K)</option>
                    <option value="12">Plourde et al. (2015) â€” Southern Cascadia LFEs (6K)</option>
                    <option value="11">Stone et al. (2018) â€” Offshore Cascadia Tectonic EQs (237)</option>
                    <option value="16">Wech (2021) â€” Cascadia Tremor (740K)</option>
                    <option value="6">Merrill et al. (2022) â€” Nootka Fault Tectonic EQs (109K)</option>
                    <option value="15">Ducellier & Creager (2022) â€” Southern Cascadia LFEs (478K)</option>
                    <option value="7">Morton et al. (2023) â€” Cascadia Subduction Tectonic EQs (5K)</option>
                    <option value="5">Littel et al. (2023) â€” Queen Charlotte Tectonic EQs (18K)</option>
                    <option value="8">Shelly et al. (2025) â€” Mendocino Triple Junction LFEs (61K)</option>
                    <option value="4">Hirao et al. (2025) â€” Mt. St. Helens Volcanic EQs (31K)</option>
                </select>
            </div>

            <!-- Compare Catalogs Section -->
            <div class="filter-section">
                <label class="filter-label">
                    <input type="checkbox" id="enable-compare" class="filter-checkbox">
                    Compare Catalogs
                </label>
                
                <div id="compare-catalogs-container" style="display: none; margin-top: 12px;">
                    <!-- Subtle info note -->
                    <div class="compare-info">
                        Max 1 overlay â€¢ 10k events
                    </div>
                    
                    <!-- Small header for clarity -->
                    <div class="compare-list-header">Select catalogs to overlay:</div>
                    
                    <div id="compare-catalogs-list" class="compare-list">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Catalog Legend with header -->
            <div id="catalog-legend" class="catalog-legend" style="display: none;">
                <div class="legend-title">Overlay Catalogs</div>
                <div id="catalog-legend-items"></div>
            </div>

            
            

            
            <details class="catalog-info-section">
                <summary class="catalog-info-header">
                    Catalog Information
                </summary>
                <div class="catalog-info-content" id="catalog-metadata">
                    <div class="info-row">
                        <span class="info-label">Publication</span>
                        <a href="#" id="catalog-doi" class="info-link" target="_blank">View Paper</a>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Region</span>
                        <span class="info-value" id="catalog-region">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Time Span</span>
                        <span class="info-value" id="catalog-timespan">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Events</span>
                        <span class="info-value" id="catalog-count">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Detection Method</span>
                        <span class="info-value" id="catalog-detection">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Association Method</span>
                        <span class="info-value" id="catalog-association">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Location Method</span>
                        <span class="info-value" id="catalog-location">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Velocity Model</span>
                        <span class="info-value" id="catalog-velocity">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Magnitude Type</span>
                        <span class="info-value" id="catalog-magnitude">â€”</span>
                    </div>
                </div>
            </details>

            <details class="filter-section" open>
                <summary class="filter-header">
                    Depth Range
                    <span class="filter-badge">
                        <span id="depth-min-val">0</span>â€“<span id="depth-max-val">100</span> km
                    </span>
                </summary>
                <div class="filter-content">
                    <div id="depth-slider" class="slider"></div>
                </div>
            </details>

            <details class="filter-section" open>
                <summary class="filter-header">
                    Magnitude
                    <span class="filter-badge">
                        <span id="mag-min-val">0.0</span>â€“<span id="mag-max-val">10.0</span>
                    </span>
                </summary>
                <div class="filter-content">
                    <div id="magnitude-slider" class="slider"></div>
                </div>
            </details>

            <details class="filter-section simple">
                <summary class="filter-header">Date Range</summary>
                <div class="filter-content">
                    <div class="date-grid">
                        <div>
                            <label class="input-label" for="start-date">Start Date</label>
                            <input type="text" id="start-date" class="date-input" placeholder="mm/dd/yyyy">
                        </div>
                        <div>
                            <label class="input-label" for="end-date">End Date</label>
                            <input type="text" id="end-date" class="date-input" placeholder="mm/dd/yyyy">
                        </div>
                    </div>
                </div>
            </details>

            <details class="filter-section simple">
                <summary class="filter-header">Spatial Bounds</summary>
                <div class="filter-content">
                    <div class="spatial-grid">
                        <div>
                            <label class="input-label" for="min-lat">Min Latitude</label>
                            <input type="number" id="min-lat" name="min-lat" class="spatial-input" step="0.1" placeholder="e.g., 39">
                        </div>
                        <div>
                            <label class="input-label" for="max-lat">Max Latitude</label>
                            <input type="number" id="max-lat" name="max-lat" class="spatial-input" step="0.1" placeholder="e.g., 52">
                        </div>
                        <div>
                            <label class="input-label" for="min-lon">Min Longitude</label>
                            <input type="number" id="min-lon" name="min-lon" class="spatial-input" step="0.1" placeholder="e.g., -130">
                        </div>
                        <div>
                            <label class="input-label" for="max-lon">Max Longitude</label>
                            <input type="number" id="max-lon" name="max-lon" class="spatial-input" step="0.1" placeholder="e.g., -116">
                        </div>
                    </div>
                </div>
            </details>

            <details class="filter-section simple">
                <summary class="filter-header">Location Uncertainty</summary>
                <div class="filter-content">
                    <div class="filter-group">
                        <label class="filter-label">
                            <input type="checkbox" id="include-missing-uncertainty" class="filter-checkbox" checked>
                            Include events with missing uncertainty
                        </label>
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <label class="input-label">Max Horizontal Error (km)</label>
                        <div id="horizontal-error-slider" class="slider"></div>
                        <div class="slider-values">
                            <span id="horiz-error-val">100</span> km
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <label class="input-label">Max Vertical Error (km)</label>
                        <div id="vertical-error-slider" class="slider"></div>
                        <div class="slider-values">
                            <span id="vert-error-val">100</span> km
                        </div>
                    </div>
                </div>
            </details>            

            <div class="filter-actions">
                <button id="show-all" class="btn-show-all">Show All Events</button>
                <div class="filter-actions-row">
                    <button id="reset-filters" class="btn-secondary">Reset Filters</button>
                    <button id="apply-filters" class="btn-primary">Apply Filters</button>
                </div>
            </div>
        </div>

        <div class="glass-panel export-panel">
            <div class="panel-header">Export Data</div>
            <div class="export-buttons">
                <button onclick="downloadFilteredData('geojson')" class="btn-export">
                    <span class="export-icon">ðŸ“¥</span> GeoJSON
                </button>
                <button onclick="downloadFilteredData('csv')" class="btn-export">
                    <span class="export-icon">ðŸ“Š</span> CSV
                </button>
            </div>
            <div class="export-hint">Downloads currently loaded earthquakes (up to 50,000 events)</div>
        </div>
    </div>

    <div class="footer-container" id="depth-legend">
        <div class="panel legend-panel">
            <div class="legend-header-row">
                <div class="legend-title">Depth (km)</div>
                <button class="legend-settings-btn" id="depth-settings-btn" title="Depth scale settings">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66z"/>
                    </svg>
                </button>
            </div>

            <div class="legend-gradient-container">
                <div class="legend-gradient"></div>
                <div class="legend-labels">
                    <span>0</span>
                    <span>20</span>
                    <span>40</span>
                    <span>60+</span>
                </div>
            </div>
        </div>

        <div class="depth-settings-panel" id="depth-settings-panel">
            <div class="settings-header">Depth Scale Settings</div>
            <div class="settings-content">
                <label class="settings-option">
                    <input type="radio" name="depth-mode" value="auto" checked>
                    <span>Auto-adjust to catalog</span>
                </label>
                <label class="settings-option">
                    <input type="radio" name="depth-mode" value="custom">
                    <span>Custom range</span>
                </label>
                <div class="custom-range-inputs" id="custom-depth-inputs">
                    <div class="range-input-group">
                        <label>Min (km)</label>
                        <input type="number" id="custom-depth-min" value="0" min="0" max="200" step="5">
                    </div>
                    <div class="range-input-group">
                        <label>Max (km)</label>
                        <input type="number" id="custom-depth-max" value="60" min="0" max="200" step="5">
                    </div>
                </div>
                <button class="btn-reset-auto" id="reset-depth-auto">Reset to Auto</button>
            </div>
        </div>
    </div>

    <div id="mouse-coords" class="coords-display">
        <span id="coords-lat">0.000</span>
        <span class="coords-separator">,</span>
        <span id="coords-lon">0.000</span>
    </div>

    <div class="analytics-panel" id="analytics-panel">
        <div class="analytics-header">
            <h3>Analytics</h3>
            <button class="btn-close-analytics" id="close-analytics">âœ•</button>
        </div>
        
        <div class="analytics-content">
            <div class="chart-container">
                <h4 class="chart-title">Event Rate vs Time</h4>
                <canvas id="chart-timeline"></canvas>
            </div>
            
            <div class="chart-container">
                <h4 class="chart-title">Magnitude Distribution</h4>
                <canvas id="chart-magnitude"></canvas>
            </div>

            <div class="chart-container">
                <h4 class="chart-title">Magnitude vs Time</h4>
                <canvas id="chart-magnitude-time"></canvas>
            </div>
            
            <div class="chart-container">
                <h4 class="chart-title">Depth Distribution</h4>
                <canvas id="chart-depth"></canvas>
            </div>
            
            <div class="chart-container">
                <h4 class="chart-title">Depth vs Time</h4>
                <canvas id="chart-depth-time"></canvas>
            </div>
        </div>
    </div>

    <button class="btn-legend-toggle" id="toggle-legend" type="button" title="Depth legend" aria-label="Depth legend">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <rect x="4" y="4" width="7" height="7" rx="1.6"></rect>
            <rect x="13" y="4" width="7" height="7" rx="1.6"></rect>
            <rect x="4" y="13" width="7" height="7" rx="1.6"></rect>
            <rect x="13" y="13" width="7" height="7" rx="1.6"></rect>
        </svg>
    </button>

    <button class="btn-show-analytics" id="show-analytics" type="button" title="Analytics dashboard" aria-label="Analytics dashboard">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M4 19V5"></path>
            <path d="M4 19H20"></path>
            <rect x="7" y="12" width="2.6" height="5.5" rx="0.9"></rect>
            <rect x="11" y="9" width="2.6" height="8.5" rx="0.9"></rect>
            <rect x="15" y="6.5" width="2.6" height="11" rx="0.9"></rect>
        </svg>
    </button>
    

    <button id="toggle-faults" class="map-control-btn" title="Toggle fault traces">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12 L8 6 L12 12 L16 8 L21 14"></path>
            <path d="M3 18 L21 18"></path>
        </svg>
    </button>


    <div class="analytics-overlay" id="analytics-overlay"></div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const legend = document.getElementById("depth-legend");
            const toggleBtn = document.getElementById("toggle-legend");

            if (!legend || !toggleBtn) return;

            // Default state
            if (window.innerWidth <= 760) {
                legend.classList.remove("is-open");
                legend.classList.add("is-closed");
            } else {
                legend.classList.remove("is-closed");
                legend.classList.add("is-open");
            }

            toggleBtn.addEventListener("click", () => {
                if (legend.classList.contains("is-open")) {
                    legend.classList.remove("is-open");
                    legend.classList.add("is-closed");
                    toggleBtn.classList.add("is-active");
                } else {
                    legend.classList.remove("is-closed");
                    legend.classList.add("is-open");
                    toggleBtn.classList.remove("is-active");
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.js"></script>
    <script type="module" src="/main.js"></script>

    <script>
    function cleanup2D() {
        // Destroy MapLibre map before switching to 3D
        if (window.map) {
            window.map.remove();
            window.map = null;
        }
    }
    </script>

<!-- About Modal -->
<div id="about-modal" class="about-modal-overlay" style="display: none;" onclick="closeAboutModal()">
  <div class="about-modal-content" onclick="event.stopPropagation()">
    <button class="about-modal-close" onclick="closeAboutModal()">Ã—</button>

    <h2>CRESCENT Earthquake Catalog Viewer</h2>

    <p>
      The <strong>Cascadia Region Earthquake Science Center (CRESCENT)</strong>
      Earthquake Catalog Viewer is a community resource for exploring
      peer-reviewed earthquake catalogs within the Cascadia Subduction Zone
      and surrounding regions.
    </p>

    <h3>Purpose</h3>
    <p>
      This viewer supports reproducible earthquake science by providing
      standardized access to curated catalogs derived using diverse
      detection, association, and location methodologies.
    </p>

    <div class="about-links">
      <a
        href="https://cascadiaquakes.github.io/earthquake_catalog_repository/"
        target="_blank"
        rel="noopener noreferrer"
        class="about-link-button"
      >
        View Documentation
      </a>
    </div>

    <h3>Project Contacts</h3>

    <div class="contact-info">

    <div class="contact-block">
        <strong>Amanda M. Thomas</strong>
        Department of Earth and Planetary Sciences<br/>
        University of California, Davis<br/>
        <a href="mailto:amthom@ucdavis.edu">amthom@ucdavis.edu</a>
    </div>

    <div class="contact-block">
        <strong>William Marfo</strong>
        Cascadia Region Earthquake Science Center<br/>
        Department of Earth and Planetary Sciences<br/>
        University of California, Davis<br/>
        <a href="mailto:wmarfo@ucdavis.edu">wmarfo@ucdavis.edu</a>
    </div>

    <div class="contact-block">
        <strong>LoÃ¯c Bachelot</strong>
        Cascadia Region Earthquake Science Center<br/>
        Department of Earth Sciences<br/>
        University of Oregon<br/>
        <a href="mailto:lbachelo@uoregon.edu">lbachelo@uoregon.edu</a>
    </div>

    </div>


    <p class="acknowledgment">
      Supported by the National Science Foundation through the
      Cascadia Region Earthquake Science Center (CRESCENT).
    </p>

  </div>
</div>


<script>
function openAboutModal() {
    document.getElementById('about-modal').style.display = 'flex';
}

function closeAboutModal() {
    document.getElementById('about-modal').style.display = 'none';
}

// Close on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAboutModal();
});
</script>


</body>
</html>